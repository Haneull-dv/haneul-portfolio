# test_inference.py - ë‰´ìŠ¤ ìš”ì•½ ëª¨ë¸ ì¶”ë¡  í…ŒìŠ¤íŠ¸
import requests
import json
import time

def test_summarization():
    """í•™ìŠµ ë°ì´í„°ì™€ ë™ì¼í•œ í˜•íƒœì˜ ë‰´ìŠ¤ë¡œ ìš”ì•½ í…ŒìŠ¤íŠ¸"""
    
    # ğŸ¯ í•™ìŠµ ë°ì´í„°ì™€ ìœ ì‚¬í•œ í˜•íƒœì˜ í…ŒìŠ¤íŠ¸ ìƒ˜í”Œë“¤
    test_samples = [
        {
            "name": "ê²Œì„ì£¼ ê¸‰ë“± ë‰´ìŠ¤",
            "news": {
                "title": "ì´ê²Œ ì–¼ë§ˆ ë§Œì´ëƒ ì—”ì”¨ì†Œí”„íŠ¸, ì‹ ì‘ ê¸°ëŒ€ê°ì— 8% ê¸‰ë“±[í•«ì¢…ëª©]",
                "description": """18ì¼ í•œêµ­ê±°ë˜ì†Œì— ë”°ë¥´ë©´ ì—”ì”¨ì†Œí”„íŠ¸(036570)ëŠ” ì „ì¼ ëŒ€ë¹„ 1ë§Œ 5000ì›(8.73%) ì˜¤ë¥¸ 18ë§Œ 6900ì›ì— ê±°ë˜ë¥¼ ë§ˆì³¤ë‹¤. ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ(293490)ë„ ì „ì¼ ëŒ€ë¹„ 950ì›(5.73%) ì˜¤ë¥¸ 1ë§Œ 7520ì›ì— ì¥ì„ ë§ˆê°í–ˆë‹¤.
ì´ì™¸ì— ë„·ë§ˆë¸”(251270)(5.61%), ë°ë¸Œì‹œìŠ¤í„°ì¦ˆ(194480)(5.13%), í¬ë˜í”„í†¤(259960)(4.08%) ë“±ì´ ê°•ì„¸ì˜€ë‹¤. ì¥í˜„êµ­ ëŒ€í‘œê°€ ì´ë„ëŠ” ë„¥ì¨ì“°(205500)ë„ ë¸”ë¡ì²´ì¸ ê²Œì„ 4ì¢…ì˜ ì˜¨ë³´ë”© ê³„ì•½ì„ ì²´ê²°í–ˆë‹¤ëŠ” ì†Œì‹ì— 9.98% ì˜¬ëë‹¤.
ê²Œì„ì£¼ ìƒìŠ¹ì€ í•˜ë°˜ê¸° ì‹ ì‘ì— ëŒ€í•œ ê¸°ëŒ€ê°ì´ ì»¤ì§„ ì˜í–¥ì´ë‹¤. ì´ë²ˆ 6ì›” ë¯¸êµ­ SGFë¥¼ ë¹„ë¡¯í•´ 8ì›”ì—ëŠ” ë…ì¼ì˜ ê²Œì„ìŠ¤ì»´, 9ì›”ì—ëŠ” ì¼ë³¸ì˜ ë„ì¿„ê²Œì„ì‡¼ê°€ ì˜ˆì •ë¼ ìˆìœ¼ë©°, ê° ê²Œì„ì‚¬ë“¤ì€ ê° ì‚¬ì˜ ê²Œì„ì„ ì¶œí’ˆí•  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤."""
            },
            "expected_summary": "ì—”ì”¨ì†Œí”„íŠ¸ ë“± ê²Œì„ì£¼ë“¤ì´ í•˜ë°˜ê¸° ì‹ ì‘ ê¸°ëŒ€ê°ìœ¼ë¡œ ê¸‰ë“±"
        },
        
        {
            "name": "AI ê¸°ìˆ  ë°œí‘œ",
            "news": {
                "title": "ìì²´ ê°œë°œí•œ AI í”Œë«í¼ 'í•˜ì´í¼í´ë¡œë°”' ê¸°ë°˜ ì„œë¹„ìŠ¤ ê³µê°œ",
                "description": """ìµœê·¼ ê¸°ì—… ë°œí‘œì— ë”°ë¥´ë©´ ìì²´ ê°œë°œí•œ AI í”Œë«í¼ 'í•˜ì´í¼í´ë¡œë°”' ê¸°ë°˜ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ê°œë°œ ê³µê°œì™€ ê´€ë ¨í•œ ë‚´ìš©ì´ ê³µì‹ì ìœ¼ë¡œ í™•ì¸ë˜ì—ˆë‹¤. í•´ë‹¹ ì´ìŠˆëŠ” AIì—…ê³„ ë° íˆ¬ìì ì‚¬ì´ì—ì„œ ì£¼ëª©ì„ ë°›ê³  ìˆìœ¼ë©°, ì—¬ëŸ¬ ë§¤ì²´ë¥¼ í†µí•´ ì„¸ë¶€ ë‚´ìš©ê³¼ ê¸°ì—… ì¸¡ ì…ì¥ì´ ë³´ë„ë˜ê³  ìˆë‹¤."""
            },
            "expected_summary": "ìì²´ ê°œë°œí•œ AI í”Œë«í¼ 'í•˜ì´í¼í´ë¡œë°”' ê¸°ë°˜ ì„œë¹„ìŠ¤ ê³µê°œ"
        },
        
        {
            "name": "íˆ¬ì/M&A ë‰´ìŠ¤",
            "news": {
                "title": "ì œ3ìë°°ì •ì¦ì ë°©ì‹ì˜ ìœ ìƒì¦ì ê²°ì •",
                "description": """ìµœê·¼ ê¸°ì—… ë°œí‘œì— ë”°ë¥´ë©´ ì œ3ìë°°ì •ì¦ì ë°©ì‹ì˜ ìœ ìƒì¦ì ê²°ì •ê³¼ ê´€ë ¨í•œ ë‚´ìš©ì´ ê³µì‹ì ìœ¼ë¡œ í™•ì¸ë˜ì—ˆë‹¤. í•´ë‹¹ ì´ìŠˆëŠ” íˆ¬ìì—…ê³„ ë° ì£¼ì£¼ë“¤ ì‚¬ì´ì—ì„œ ì£¼ëª©ì„ ë°›ê³  ìˆìœ¼ë©°, ì—¬ëŸ¬ ë§¤ì²´ë¥¼ í†µí•´ ì„¸ë¶€ ë‚´ìš©ê³¼ ê¸°ì—… ì¸¡ ì…ì¥ì´ ë³´ë„ë˜ê³  ìˆë‹¤."""
            },
            "expected_summary": "ì œ3ìë°°ì •ì¦ì ë°©ì‹ì˜ ìœ ìƒì¦ì ê²°ì •"
        },
        
        {
            "name": "ê²Œì„ ì¶œì‹œ ì†Œì‹",
            "news": {
                "title": "ì‹ ì‘ MMORPG 'ë‚˜ì´íŠ¸ í¬ë¡œìš°' ì‚¬ì „ ì˜ˆì•½ ì‹œì‘",
                "description": """ìµœê·¼ ê¸°ì—… ë°œí‘œì— ë”°ë¥´ë©´ ì‹ ì‘ MMORPG 'ë‚˜ì´íŠ¸ í¬ë¡œìš°'ì˜ í”„ë¦¬ë·° ì˜ìƒ ê³µê°œ ë° ì‚¬ì „ ì˜ˆì•½ ì‹œì‘ê³¼ ê´€ë ¨í•œ ë‚´ìš©ì´ ê³µì‹ì ìœ¼ë¡œ í™•ì¸ë˜ì—ˆë‹¤. í•´ë‹¹ ì´ìŠˆëŠ” ê²Œì„ì—…ê³„ ë° ê²Œì´ë¨¸ë“¤ ì‚¬ì´ì—ì„œ ì£¼ëª©ì„ ë°›ê³  ìˆìœ¼ë©°, ì—¬ëŸ¬ ë§¤ì²´ë¥¼ í†µí•´ ì„¸ë¶€ ë‚´ìš©ê³¼ ì¶œì‹œ ì¼ì •ì´ ë³´ë„ë˜ê³  ìˆë‹¤."""
            },
            "expected_summary": "ì‹ ì‘ MMORPG 'ë‚˜ì´íŠ¸ í¬ë¡œìš°' ì‚¬ì „ ì˜ˆì•½ ì‹œì‘"
        }
    ]
    
    # FastAPI inference ì—”ë“œí¬ì¸íŠ¸
    URL = "http://localhost:8003/api/v1/summarize"
    
    print("ğŸš€ ë‰´ìŠ¤ ìš”ì•½ ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‹œì‘")
    print("=" * 60)
    
    success_count = 0
    total_count = len(test_samples)
    
    for i, sample in enumerate(test_samples, 1):
        print(f"\nğŸ“° í…ŒìŠ¤íŠ¸ {i}/{total_count}: {sample['name']}")
        print("-" * 40)
        
        try:
            # ìš”ì²­ ë°ì´í„° ì¤€ë¹„ (SummarizeRequest ìŠ¤í‚¤ë§ˆì— ë§ì¶¤)
            payload = {"news": sample["news"]}
            
            print(f"ğŸ“ ì…ë ¥ í—¤ë“œë¼ì¸: {sample['news']['title']}")
            print(f"ğŸ“„ ì…ë ¥ ë””ìŠ¤í¬ë¦½ì…˜: {sample['news']['description'][:100]}...")
            print(f"ğŸ¯ ì˜ˆìƒ ìš”ì•½: {sample['expected_summary']}")
            
            # API í˜¸ì¶œ
            start_time = time.time()
            response = requests.post(URL, json=payload, timeout=30)
            end_time = time.time()
            
            if response.ok:
                result = response.json()
                actual_summary = result.get("summary", "")
                title_field = result.get("title", "")
                status = result.get("status", "unknown")
                
                print(f"âœ… ì‘ë‹µ ìƒíƒœ: {status}")
                print(f"âš¡ ì²˜ë¦¬ ì‹œê°„: {end_time - start_time:.2f}ì´ˆ")
                print(f"ğŸ“‹ ì‹¤ì œ ìš”ì•½: {actual_summary}")
                print(f"ğŸ·ï¸  title í•„ë“œ: {title_field}")
                
                # ìš”ì•½ í’ˆì§ˆ ê°„ë‹¨ í‰ê°€
                if actual_summary and len(actual_summary.strip()) > 0:
                    print("âœ… ìš”ì•½ ìƒì„± ì„±ê³µ")
                    success_count += 1
                    
                    # í•œ ì¤„ì¸ì§€ í™•ì¸
                    if "\n" not in actual_summary.strip():
                        print("âœ… í•œ ì¤„ ìš”ì•½ ì„±ê³µ")
                    else:
                        print("âš ï¸  ì—¬ëŸ¬ ì¤„ ìš”ì•½ (í•œ ì¤„ ìš”ì•½ ëª©í‘œì™€ ë‹¤ë¦„)")
                        
                    # titleê³¼ summary ì¼ì¹˜ í™•ì¸
                    if title_field == actual_summary:
                        print("âœ… titleê³¼ summary í•„ë“œ ì¼ì¹˜")
                    else:
                        print("âš ï¸  titleê³¼ summary í•„ë“œ ë¶ˆì¼ì¹˜")
                else:
                    print("âŒ ìš”ì•½ ìƒì„± ì‹¤íŒ¨ (ë¹ˆ ê²°ê³¼)")
                    
            else:
                print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨: {response.status_code}")
                print(f"   ì—ëŸ¬ ë©”ì‹œì§€: {response.text}")
                
        except requests.exceptions.Timeout:
            print("âŒ ìš”ì²­ íƒ€ì„ì•„ì›ƒ (30ì´ˆ ì´ˆê³¼)")
        except requests.exceptions.ConnectionError:
            print("âŒ ì—°ê²° ì˜¤ë¥˜ - ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”")
        except Exception as e:
            print(f"âŒ ì˜ˆì™¸ ë°œìƒ: {str(e)}")
    
    # ì „ì²´ ê²°ê³¼ ìš”ì•½
    print("\n" + "=" * 60)
    print(f"ğŸ¯ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
    print(f"   ì„±ê³µ: {success_count}/{total_count} ({success_count/total_count*100:.1f}%)")
    
    if success_count == total_count:
        print("ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
    elif success_count > 0:
        print("âš ï¸  ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
    else:
        print("âŒ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”")

def test_server_health():
    """ì„œë²„ ìƒíƒœ í™•ì¸"""
    try:
        health_url = "http://localhost:8003/api/v1/health"
        response = requests.get(health_url, timeout=5)
        
        if response.ok:
            print("âœ… ì„œë²„ ìƒíƒœ: ì •ìƒ")
            return True
        else:
            print(f"âš ï¸  ì„œë²„ ì‘ë‹µ ì´ìƒ: {response.status_code}")
            return False
    except:
        print("âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        return False

if __name__ == "__main__":
    print("ğŸ” ë‰´ìŠ¤ ìš”ì•½ ëª¨ë¸ ì¶”ë¡  í…ŒìŠ¤íŠ¸")
    print("í•™ìŠµ ë°ì´í„°ì™€ ë™ì¼í•œ í˜•íƒœì˜ ì…ë ¥ìœ¼ë¡œ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # 1. ì„œë²„ ìƒíƒœ í™•ì¸
    print("1ï¸âƒ£  ì„œë²„ ìƒíƒœ í™•ì¸")
    if not test_server_health():
        print("\nâŒ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”:")
        print("cd slm-summarizer-inference && python main.py")
        exit(1)
    
    print("\n2ï¸âƒ£  ìš”ì•½ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸")
    # 2. ìš”ì•½ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test_summarization()
